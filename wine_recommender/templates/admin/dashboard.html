{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="admin-container">
	<!-- Debug Information -->
	<div style="display: none;">
		<p>Debug Data:</p>
		<p>Dates: {{ dates }}</p>
		<p>Registrations: {{ registrations }}</p>
		<p>Wine Categories: {{ wine_categories }}</p>
		<p>Category Counts: {{ category_counts }}</p>
		<p>Role Distribution: {{ role_distribution }}</p>
		<p>Months: {{ months }}</p>
		<p>Revenue Data: {{ revenue_data }}</p>
	</div>

	<!-- Sidebar -->
	<aside class="admin-sidebar">
		<div class="sidebar-brand">
			<img
				src="{{ url_for('static', filename='images/logo.svg') }}"
				alt="Wine Expert"
				height="32"
			/>
			<span>Admin Panel</span>
		</div>

		<nav class="sidebar-nav">
			<div class="nav-section">
				<span class="nav-section-title">MAIN</span>
				<a href="{{ url_for('admin.dashboard') }}" class="nav-link active">
					<i class="fas fa-chart-line"></i>
					<span>Dashboard</span>
				</a>
				<a href="{{ url_for('admin.users') }}" class="nav-link">
					<i class="fas fa-users"></i>
					<span>Users</span>
				</a>
			</div>

			<div class="nav-section">
				<span class="nav-section-title">CATALOG</span>
				<a href="#" class="nav-link">
					<i class="fas fa-wine-bottle"></i>
					<span>Wines</span>
				</a>
				<a href="#" class="nav-link">
					<i class="fas fa-tags"></i>
					<span>Categories</span>
				</a>
			</div>

			<div class="nav-section">
				<span class="nav-section-title">SALES</span>
				<a href="#" class="nav-link">
					<i class="fas fa-shopping-cart"></i>
					<span>Orders</span>
					<span class="nav-badge">3</span>
				</a>
				<a href="{{ url_for('admin.inventory') }}" class="nav-link">
					<i class="fas fa-box"></i>
					<span>Inventory</span>
				</a>
			</div>

			<div class="nav-section">
				<span class="nav-section-title">SYSTEM</span>
				<a href="#" class="nav-link">
					<i class="fas fa-cog"></i>
					<span>Settings</span>
				</a>
				<a href="#" class="nav-link">
					<i class="fas fa-chart-bar"></i>
					<span>Analytics</span>
				</a>
			</div>
		</nav>
	</aside>

	<!-- Main Content -->
	<main class="admin-main">
		<header class="admin-header">
			<div class="header-left">
				<button class="menu-toggle">
					<i class="fas fa-bars"></i>
				</button>
				<h1>Dashboard</h1>
			</div>
			<div class="header-right">
				<div class="header-search">
					<i class="fas fa-search"></i>
					<input type="text" placeholder="Search..." />
				</div>
				<button class="btn-icon">
					<i class="fas fa-bell"></i>
					<span class="badge">2</span>
				</button>
			</div>
		</header>

		<div class="admin-content">
			<!-- Stats Grid -->
			<div class="stats-grid">
				<div class="stat-card primary">
					<div class="stat-card-content">
						<h3>Total Users</h3>
						<div class="stat-value">{{ total_users }}</div>
						<div class="stat-change positive">
							<i class="fas fa-arrow-up"></i>
							<span>12.5%</span>
							<span class="period">vs last month</span>
						</div>
					</div>
					<div class="stat-icon">
						<i class="fas fa-users"></i>
					</div>
				</div>

				<div class="stat-card success">
					<div class="stat-card-content">
						<h3>Total Wines</h3>
						<div class="stat-value">{{ category_counts|sum }}</div>
						<div class="stat-change positive">
							<i class="fas fa-arrow-up"></i>
							<span>8.3%</span>
							<span class="period">vs last month</span>
						</div>
					</div>
					<div class="stat-icon">
						<i class="fas fa-wine-bottle"></i>
					</div>
				</div>

				<div class="stat-card info">
					<div class="stat-card-content">
						<h3>Total Orders</h3>
						<div class="stat-value">384</div>
						<div class="stat-change positive">
							<i class="fas fa-arrow-up"></i>
							<span>5.7%</span>
							<span class="period">vs last month</span>
						</div>
					</div>
					<div class="stat-icon">
						<i class="fas fa-shopping-cart"></i>
					</div>
				</div>

				<div class="stat-card warning">
					<div class="stat-card-content">
						<h3>Revenue</h3>
						<div class="stat-value">${{ revenue_data[-1] }}</div>
						<div class="stat-change negative">
							<i class="fas fa-arrow-down"></i>
							<span>2.1%</span>
							<span class="period">vs last month</span>
						</div>
					</div>
					<div class="stat-icon">
						<i class="fas fa-dollar-sign"></i>
					</div>
				</div>
			</div>

			<!-- Charts Grid -->
			<div class="charts-grid">
				<!-- User Registration Chart -->
				<div class="card chart-card">
					<div class="card-header">
						<h2>User Registrations</h2>
						<div class="card-actions">
							<button class="btn-outline">
								<i class="fas fa-download me-2"></i>Export
							</button>
						</div>
					</div>
					<div class="card-body">
						<canvas id="userRegistrationChart"></canvas>
					</div>
				</div>

				<!-- Wine Categories Chart -->
				<div class="card chart-card">
					<div class="card-header">
						<h2>Wine Categories</h2>
						<div class="card-actions">
							<button class="btn-outline">
								<i class="fas fa-download me-2"></i>Export
							</button>
						</div>
					</div>
					<div class="card-body">
						<canvas id="wineCategoriesChart"></canvas>
					</div>
				</div>

				<!-- Revenue Chart -->
				<div class="card chart-card">
					<div class="card-header">
						<h2>Monthly Revenue</h2>
						<div class="card-actions">
							<button class="btn-outline">
								<i class="fas fa-download me-2"></i>Export
							</button>
						</div>
					</div>
					<div class="card-body">
						<canvas id="revenueChart"></canvas>
					</div>
				</div>

				<!-- User Roles Chart -->
				<div class="card chart-card">
					<div class="card-header">
						<h2>User Roles</h2>
						<div class="card-actions">
							<button class="btn-outline">
								<i class="fas fa-download me-2"></i>Export
							</button>
						</div>
					</div>
					<div class="card-body">
						<canvas id="userRolesChart"></canvas>
					</div>
				</div>
			</div>
		</div>
	</main>
</div>
{% endblock %}

{% block extra_css %}
<style>
	/* Reset base styles */
	body {
		padding-top: 0 !important;
		min-height: 100vh;
		display: flex;
		flex-direction: column;
	}

	.content-wrapper {
		flex: 1;
		display: flex;
		flex-direction: column;
		min-height: calc(100vh - 76px);
		margin: 0;
		padding: 0;
	}

	.footer {
		margin-top: 0;
	}

	/* Admin Layout */
	.admin-wrapper {
		display: flex;
		min-height: calc(100vh - 76px);
		background-color: #f8f9fa;
		margin: 0;
		padding: 0;
	}

	/* Sidebar */
	.admin-sidebar {
		width: 260px;
		background: white;
		border-right: 1px solid rgba(0, 0, 0, 0.1);
		display: flex;
		flex-direction: column;
		flex-shrink: 0;
		height: calc(100vh - 76px);
		position: fixed;
		overflow-y: auto;
	}

	.sidebar-header {
		padding: 1.5rem;
		border-bottom: 1px solid rgba(0, 0, 0, 0.1);
		background: white;
	}

	.sidebar-menu {
		padding: 1rem 0;
	}

	.menu-item {
		display: flex;
		align-items: center;
		padding: 0.875rem 1.5rem;
		color: var(--text-primary);
		text-decoration: none;
		transition: all 0.3s ease;
	}

	.menu-item i {
		width: 20px;
		margin-right: 0.75rem;
		font-size: 1.1rem;
	}

	.menu-item:hover {
		background-color: var(--wine-light);
		color: var(--wine-primary);
		transform: translateX(5px);
	}

	.menu-item.active {
		background-color: var(--wine-primary);
		color: white;
	}

	.menu-item.active:hover {
		transform: none;
	}

	/* Main Content */
	.admin-content {
		flex: 1;
		margin-left: 260px;
		padding: 2rem;
		background-color: #f8f9fa;
		min-height: calc(100vh - 76px);
		overflow-y: auto;
	}

	.admin-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 2rem;
	}

	/* Stats Cards */
	.stat-card {
		height: 100%;
		background: white;
		border-radius: 12px;
		padding: 1.5rem;
		display: flex;
		justify-content: space-between;
		align-items: center;
		box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
		transition: transform 0.2s ease, box-shadow 0.2s ease;
	}

	.stat-card:hover {
		transform: translateY(-5px);
		box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
	}

	.stat-card-title {
		color: var(--text-secondary);
		margin-bottom: 0.5rem;
		font-size: 0.875rem;
	}

	.stat-card-value {
		font-size: 1.75rem;
		font-weight: 600;
		color: var(--text-primary);
		margin-bottom: 0.5rem;
	}

	.stat-card-change {
		font-size: 0.875rem;
		display: flex;
		align-items: center;
		gap: 0.25rem;
	}

	.stat-card-change.positive {
		color: #28a745;
	}

	.stat-card-change.negative {
		color: #dc3545;
	}

	.stat-card-icon {
		width: 48px;
		height: 48px;
		border-radius: 12px;
		background-color: var(--wine-light);
		color: var(--wine-primary);
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 1.5rem;
	}

	/* Table Styles */
	.table > :not(caption) > * > * {
		padding: 1rem 1.5rem;
	}

	.user-avatar {
		width: 32px;
		height: 32px;
		border-radius: 50%;
		background-color: var(--wine-primary);
		color: white;
		display: flex;
		align-items: center;
		justify-content: center;
		font-weight: 600;
	}

	.badge {
		padding: 0.5rem 0.75rem;
		font-weight: 500;
	}

	/* Card Styles */
	.card {
		border: none;
		border-radius: 12px;
		box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
	}

	.card-header {
		background-color: transparent;
		border-bottom: 1px solid rgba(0, 0, 0, 0.1);
		padding: 1.25rem 1.5rem;
	}

	.card-body {
		padding: 1.5rem;
	}

	/* Responsive */
	@media (max-width: 991.98px) {
		.admin-sidebar {
			position: fixed;
			left: -260px;
			top: 76px;
			height: calc(100vh - 76px);
			z-index: 1030;
			transition: left 0.3s ease;
		}

		.admin-sidebar.show {
			left: 0;
		}

		.admin-content {
			margin-left: 0;
			width: 100%;
		}
	}

	/* Chart Styles */
	.chart-card {
		background: white;
		border-radius: 0.5rem;
		box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
		margin-bottom: 1.5rem;
	}

	.chart-card .card-body {
		padding: 1.5rem;
		height: 300px;
		position: relative;
	}

	.chart-card canvas {
		width: 100% !important;
		height: 100% !important;
	}

	/* Charts Grid */
	.charts-grid {
		display: grid;
		grid-template-columns: repeat(2, 1fr);
		gap: 1.5rem;
		margin-top: 2rem;
	}

	@media (max-width: 991.98px) {
		.charts-grid {
			grid-template-columns: 1fr;
		}
	}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
	console.log('DOM Content Loaded');
	
	// Chart.js configuration
	const chartConfig = {
		responsive: true,
		maintainAspectRatio: false,
		plugins: {
			legend: {
				position: 'bottom'
			}
		}
	};

	// Debug data
	console.log('Dates:', {{ dates|tojson }});
	console.log('Registrations:', {{ registrations|tojson }});
	console.log('Wine Categories:', {{ wine_categories|tojson }});
	console.log('Category Counts:', {{ category_counts|tojson }});
	console.log('Role Distribution:', {{ role_distribution|tojson }});
	console.log('Months:', {{ months|tojson }});
	console.log('Revenue Data:', {{ revenue_data|tojson }});

	// User Registration Chart
	const userRegistrationCtx = document.getElementById('userRegistrationChart');
	console.log('User Registration Canvas:', userRegistrationCtx);
	if (userRegistrationCtx) {
		try {
			new Chart(userRegistrationCtx, {
				type: 'line',
				data: {
					labels: {{ dates|tojson }},
					datasets: [{
						label: 'New Users',
						data: {{ registrations|tojson }},
						borderColor: '#4299e1',
						backgroundColor: 'rgba(66, 153, 225, 0.1)',
						tension: 0.4,
						fill: true
					}]
				},
				options: {
					...chartConfig,
					scales: {
						y: {
							beginAtZero: true,
							ticks: {
								stepSize: 5
							}
						}
					}
				}
			});
			console.log('User Registration Chart created successfully');
		} catch (error) {
			console.error('Error creating User Registration Chart:', error);
		}
	}

	// Wine Categories Chart
	const wineCategoriesCtx = document.getElementById('wineCategoriesChart');
	console.log('Wine Categories Canvas:', wineCategoriesCtx);
	if (wineCategoriesCtx) {
		try {
			new Chart(wineCategoriesCtx, {
				type: 'doughnut',
				data: {
					labels: {{ wine_categories|tojson }},
					datasets: [{
						data: {{ category_counts|tojson }},
						backgroundColor: [
							'#e53e3e',
							'#48bb78',
							'#ed64a6',
							'#4299e1',
							'#ecc94b'
						]
					}]
				},
				options: chartConfig
			});
			console.log('Wine Categories Chart created successfully');
		} catch (error) {
			console.error('Error creating Wine Categories Chart:', error);
		}
	}

	// Revenue Chart
	const revenueCtx = document.getElementById('revenueChart');
	console.log('Revenue Canvas:', revenueCtx);
	if (revenueCtx) {
		try {
			new Chart(revenueCtx, {
				type: 'bar',
				data: {
					labels: {{ months|tojson }},
					datasets: [{
						label: 'Revenue',
						data: {{ revenue_data|tojson }},
						backgroundColor: '#48bb78',
						borderRadius: 4
					}]
				},
				options: {
					...chartConfig,
					scales: {
						y: {
							beginAtZero: true,
							ticks: {
								callback: function(value) {
									return '$' + value;
								}
							}
						}
					}
				}
			});
			console.log('Revenue Chart created successfully');
		} catch (error) {
			console.error('Error creating Revenue Chart:', error);
		}
	}

	// User Roles Chart
	const userRolesCtx = document.getElementById('userRolesChart');
	console.log('User Roles Canvas:', userRolesCtx);
	if (userRolesCtx) {
		try {
			new Chart(userRolesCtx, {
				type: 'pie',
				data: {
					labels: {{ role_distribution.keys()|list|tojson }},
					datasets: [{
						data: {{ role_distribution.values()|list|tojson }},
						backgroundColor: [
							'#4299e1',
							'#48bb78',
							'#ecc94b'
						]
					}]
				},
				options: chartConfig
			});
			console.log('User Roles Chart created successfully');
		} catch (error) {
			console.error('Error creating User Roles Chart:', error);
		}
	}
});
</script>
{% endblock %}
